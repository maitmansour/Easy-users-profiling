<!--
Author: 
- Mohamed AIT MANSOUR
- Meryem BELGHARBI
-->

<html>
	<head>
			<title>Produits</title>
			<link href="css/bootstrap.min.css" rel="stylesheet" type="text/css">
			<link href="css/bootstrap.css" rel="stylesheet" type="text/css">
			<link href="css/theme.css" rel="stylesheet" type="text/css">
			<meta name="viewport" content="width=device-width, initial-scale=1">
			
			<!----webfonts---->
			<link href="http://fonts.googleapis.com/css?family=Open+Sans:400,600,700,800,300" rel="stylesheet" type="text/css">
			<!----//webfonts---->
			<script type="text/javascript" src="js/jquery.min.js"></script>
			<script type="text/javascript" src="js/bootstrap.js"></script>
			<script type="text/javascript" src="js/bootstrap.min.js"></script>
			<!--  jquery plguin -->
	</head>

	<body>
		<div class="header-bg">
			<div class="container">
				<div class="row">
					
					<div>					
	 					<nav class="navbar navbar-default" role="navigation">
						  <div class="container-fluid">
						    
						    					
						    
						    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
						      <ul class="nav navbar-nav">
						      	 <li>
						         <div class="btn-group show-on-hover">
							          <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown">
							            <span id="choosen_user"></span><span class="caret"></span>
							          </button>
							          <ul class="dropdown-menu" role="menu" id="users">
							          </ul>
							        </div>						          
						        </li>
						        
						        
						        
						      </ul>							      					    					      
						    </div>
						  </div><!-- /.container-fluid -->
						</nav>
							
					</div>
						
				  
      
				</div>
			</div>
        </div>
		<div class="container">
			 <div class="content">	
				 <div class="row">
				 	<div class="col-md-12 text-center" id="suggested_product">
				 	</div>
				 	<div class="col-md-12 text-center">
				 		<h2>Produits</h2>
				 	</div>
				 	<hr>
				 </div>	
				<div class="row" id="produits">
						<!----Les produits seront chargées dans ce div---->
				</div>
			</div>
		</div>
	</body>
</html>
<!----Importer les données JSON---->
  <script src="data/produits.js"></script>
  <script src="data/users.js"></script>

<!----Le code qui permet le chargement des données à partir du JSON---->
<script type="text/javascript">
	  var clicks=1;
	  var clicked_items=[];
	  var choosen_products=[];

$( document ).ready(function() {
	//var arr=[1,2,3,4,5,7,8,9,10];
	//alert(getClosest(6,arr));
  var items = "";
  var users_html="";
    	var url_string = window.location.href;
		var url = new URL(url_string);
		var user_id = url.searchParams.get("user_id");
if (user_id==null) {
	user_id=1;
}
 $('#choosen_user').html('Switch users ( Current user '+user_id+' )');

/* Itération sur les produits et génération des div qui contiens les informations des produits*/
  $.each( data, function( key, val ) {

var category = '<div class="col-md-2">'+
'					<div class="grid">'+
'						<div class="portfolio app mix_all" >'+
'							<div class="portfolio-wrapper">		'+
'								<a data-toggle="modal" data-target="#modal_'+val.id+'" href="#" class="b-link-stripe b-animate-go  thickbox" onclick="updateWeights('+user_id+','+val.id+','+val.weights.is_done+')">'+
'							     <img src="images/produits/'+val.id+'.png" style="height:186"><div class="b-wrapper"><h2 class="b-animate b-from-left    b-delay03 "><img src="images/link-ico.png" alt=""/></h2></div>'+
'							  	</a>'+
'			                </div>'+
'					    </div>		'+
'						<p class="text-center">'+val.title+'</p>'+
'                    </div>'+
'				</div>'+
'<!----start-model-box-'+val.id+'---->'+
'						<div class="modal fade bs-example-modal-md light-box" tabindex="-1" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true" id="modal_'+val.id+'">'+
'						  <div class="modal-dialog modal-md">'+
'						    <div class="modal-content light-box-info">'+
'						    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><img src="images/close.png" title="close" /></button>'+
'						     <h3 id="modal_title">'+val.title+'</h3>'+
'						     <p id="modal_details">'+val.description+'</p>'+
'<ul id="product_'+val.id+'_data">'+
'  <li>Male : '+val.weights.male+'</li>'+
'  <li>Female : '+val.weights.female+'</li>'+
'  <li>Child : '+val.weights.child+'</li>'+
'  <li>Teen : '+val.weights.teen+'</li>'+
'  <li>Adult : '+val.weights.adult+'</li>'+
'  <li>Old : '+val.weights.old+'</li>'+
'</ul>'+
'						    </div>'+
'						  </div>'+
'						</div>'+
'						<!----start-model-box---->';
	
    items+=category;
  });
 $('#produits').append(items);

   $.each( users, function( key, val ) {
  	
	var user = '<li><a href="?user_id='+val.id+'">'+val.username+'</a></li>';
    users_html+=user;
  });
  $('#users').append(users_html);

});
							           
function updateWeights(user_id,product_id,is_done) {

	if (is_done) {
  		$('#suggested_product').html('');
		clicks++;
		//alert(product_id);
		clicked_items.push(product_id);

	}else{
		clicked_items=clicked_items.filter((v, i, a) => a.indexOf(v) === i); 
		for (var i = 0; i <clicked_items.length ; i++) {
				choosen_products.push(data[clicked_items[i]-1].weights);
			}
			var points=[];
		for (var i = 0; i <choosen_products.length ; i++) {
			    points.push([choosen_products[i].male,choosen_products[i].male,
							choosen_products[i].female,choosen_products[i].female,
							choosen_products[i].child,choosen_products[i].child,
							choosen_products[i].teen,choosen_products[i].teen,
							choosen_products[i].adult,choosen_products[i].adult,
							choosen_products[i].old,choosen_products[i].old]);
			}
		
		// get new weight, based on barycenter 
		var new_weight=getCentroid(points);
		suggestProduct(new_weight);
		console.log(getCentroid(points));
		clicks=0;
		clicked_items=[];
		choosen_products=[];
	}
}


function suggestProduct(weights) {
// TOODO compare weight with existing weights and siggest one product
var suggested_product=calculateMansourWeight(weights,data);
console.log(JSON.stringify(suggested_product));
var finded_product = '<h2>Suggested Product : </h2>'+
'    					<div class="portfolio app mix_all">							<div class="portfolio-wrapper">										<a data-toggle="modal" data-target="#modal_2" href="#" class="b-link-stripe b-animate-go  thickbox" onclick="updateWeights(1,2,true)">							     <img src="images/produits/'+suggested_product.id+'.png" style="height:186"><div class="b-wrapper"><h2 class="b-animate b-from-left    b-delay03 "><img src="images/link-ico.png" alt=""></h2></div>							  	</a>			                </div>					    </div>';
  $('#suggested_product').html(finded_product);
}

// Barycenter calculator
var getCentroid = function (coord) 
{
	var center = coord.reduce(function (x,y) {
		return [x[0] + y[0]/coord.length, x[1] + y[1]/coord.length, x[2] + y[2]/coord.length, x[3] + y[3]/coord.length, x[4] + y[4]/coord.length, x[5] + y[5]/coord.length] 
	}, [0,0,0,0,0,0])
	return center;
}

function getClosest(search, arr) {
   var closest = null;
    $.each( arr, function( key, val ) {
    	if (closest==null||Math.abs(search-closest)>Math.abs(val-search)) {
    		closest = val;
    	}
	});
   return closest;
}

function calculateMansourWeight(new_weight,data) {
	var sommes=[];
  $.each( data, function( i, val ) {
  	var somme=0;
  	if (val.weights.is_done) {
  		somme+=val.weights.male-new_weight[0];
somme+=val.weights.female-new_weight[1];
somme+=val.weights.child-new_weight[2];
somme+=val.weights.teen-new_weight[3];
somme+=val.weights.adult-new_weight[4];
somme+=val.weights.old-new_weight[5];
    			sommes.push(Math.abs(somme));
  	}
	});
  console.log("NEW WEIGHT : ");
  console.log(new_weight);
  console.log("SOMMES : ");
  console.log(sommes);
  var min=Math.min.apply( Math, sommes );
  console.log("MINIMUM : ");
  console.log(min);
      for (var i=0; i<sommes.length; i++)
        if (sommes[i] === min){
        	console.log("CHOOSEN : "+i);
        	return data[i];
        } 
}
</script>